#!/usr/bin/env bash

postgresql_initdb()
{
  ensure_paths_exist "$pgsql_path/$version"

  chown_paths "$postgresql_user" "$pgsql_path"

  log "
Initializing postgresql $version data directory in $pgsql_path/$version
with superuser set to '$postgresql_user'.
"
  command="'$install_path/bin/initdb' --pgdata='$pgsql_path/data' --encoding=utf8 --username=$postgresql_user"
  create_test="$install_path/bin/createdb test --username ${postgresql_user}"

  if running_as_root ; then
    run_as_user "${postgresql_user}" "${command}"
    run_as_user "${postgresql_user}" "$create_test"
  else
    "${command}"
    "${create_test}"
  fi

  postgresql_configure
}

postgresql_configure()
{
  if [[ ! -d "$pgsql_path/data" ]] ; then
    log "Symlinking postgresql data directory.\n"

    remove_files "$pgsql_path/data"

    link "$pgsql_path/$version"\
      to "$pgsql_path/data"
  fi

  if [[ ! -s "$pgsql_path/data/postgresql.conf" ]] ; then
    log "Installing postgresql.conf."

    copy "$pgsql_path/postgresql.conf.sample" \
      to "$pgsql_path/data/postgresql.conf"
  fi

  chown_paths "$postgresql_user" "$pgsql_path" # One more for good measure.

  log "\nSymlinking $install_path to $prefix_path/postgresql"

  remove_paths "$prefix_path/postgresql"

  link "$install_path" to "$prefix_path/postgresql"

  ensure_paths_exists "$data_path" "$log_dir"

  chown_paths "$postgresql_user" "$data_path" "$log_dir"

  chmod_paths 0700 "$data_path"
}

configure_postgresql_for_users()
{
  # TODO: Make this a bit more robust.
  log "\nNow updating $HOME/.bash_profile with the postgres environment...\n"
  for profile in "${profiles[@]}" ; do
    if ! grep -q "PGUSER" $profile ; then
      echo "export PGUSER='$postgresql_user'" \
        >> "$profile.postgres"
    fi

    if ! grep -q "PGDATA" $profile ; then
      echo "export PGDATA='$pgsql_path/data'" \
        >> "$profile.postgres"
    fi

    if ! grep -q "PGLOG" $profile ; then
      echo "export PGLOG='$pgsql_path/server.log'" \
        >> "$profile.postgres"
    fi

    if ! grep -q "$install_path" $profile ; then
      echo "export PATH=\"$prefix_path/postgresql/bin:\$PATH\"" \
        >> "$profile.postgres"
    fi

    move "${profile}" \
      to "${profile}.${timestamp}"

    move "${profile}.postgres" \
      to "${profile}"
  done

  log "NOTE: Your original .bash_profile has been backed up as $HOME/.bash_profile.$timestamp"
}


postgresql_ldconfig()
{
  if running_as_root && os_is_linux ; then
    echo "${install_path}/lib" \
      > /etc/ld.so.conf.d/postgresql.conf

    /sbin/ldconfig
  fi
}
