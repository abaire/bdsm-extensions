#!/usr/bin/env bash

# TODO: Move this to an extension action.
postgresql_initdb()
{
  ensure_paths_exist "$pgsql_path/$version"

  chown_paths "$user" "$pgsql_path"

  log "
Initializing postgresql $version data directory in $pgsql_path/$version
with superuser set to '$user'.
"
  command="'$install_path/bin/initdb' --pgdata='$pgsql_path/data' --encoding=utf8 --username=$user"
  if [[ $UID -eq 0 ]] ; then
    run_as_user "${user}" "${command}"
  else
    "${command}"
  fi

  postgresql_configure
}

postgresql_configure()
{
  if [[ ! -d "$pgsql_path/data" ]] ; then
    log "Symlinking postgresql data directory.\n"
    remove_files "$pgsql_path/data"
    link "$pgsql_path/$version"\
      to "$pgsql_path/data"
  fi

  if [[ ! -s "$pgsql_path/data/postgresql.conf" ]] ; then
    log "Installing postgresql.conf."

    copy "$pgsql_path/postgresql.conf.sample" \
      to "$pgsql_path/data/postgresql.conf"
  fi

  chown_paths "$user" "$pgsql_path" # One more for good measure.

  log "\nSymlinking $install_path to $prefix_path/postgresql"

  remove_paths "$prefix_path/postgresql"

  link "$install_path" to "$prefix_path/postgresql"
}

configure_postgresql_for_users()
{
  # TODO: Make this a bit more robust.
  log "\nNow updating $HOME/.bash_profile with the postgres environment...\n"
  for profile in "${profiles[@]}" ; do
    if ! grep -q "PGUSER" $profile ; then
      echo "export PGUSER='$user'" \
        >> "$profile.postgres"
    fi

    if ! grep -q "PGDATA" $profile ; then
      echo "export PGDATA='$pgsql_path/data'" \
        >> "$profile.postgres"
    fi

    if ! grep -q "PGLOG" $profile ; then
      echo "export PGLOG='$pgsql_path/server.log'" \
        >> "$profile.postgres"
    fi

    if ! grep -q "$install_path" $profile ; then
      echo "export PATH=\"$prefix_path/postgresql/bin:\$PATH\"" \
        >> "$profile.postgres"
    fi

    move "${profile}" \
      to "${profile}.${timestamp}"

    move "${profile}.postgres" \
      to "${profile}"
  done

  log "NOTE: Your original .bash_profile has been backed up as $HOME/.bash_profile.$timestamp"
}
