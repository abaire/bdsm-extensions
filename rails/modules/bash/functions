#!/usr/bin/env bash

install_gems() {
  local _gem

  for _gem in "$*" ; do
    gem install ${_gem} --no-rdoc --no-ri
  done
}

configure_database_yml()
{
  if [[ ! -s "$shared_path/config/database.yml" ]] ; then
    printf "\n${environment}: &defaults\n  adapter: ${database:-postgresql}\n  username: $project\n  password: '$project'\n  database: ${project}_${environment}\n  pool: 5\n  timeout: 5000\n" > "$shared_path/config/database.yml"
    if [[ "$database" = "mysql" ]] ; then
      printf "\n  socket: ${socket:-/tmp/mysql.sock}\n  encoding: utf8\n" >> "$shared_path/config/database.yml"
    fi
  fi

  if variable_is_nonempty database && command_exists gem ; then
    case "$database" in
      postgresql)
        install_gems pg
        if [[ "$?" -ne 0 ]] ; then
          pg_config=$(command -v pg_config)
          gem install pg --no-rdoc --no-ri -- --with-pg-config=${pg_config:-/usr/local/postgresql/bin/pg_config}
        fi
        ;;

      mysql)
        install_gems mysql
        if [[ "$?" -ne 0 ]] ; then
          mysql_config=$(command -v mysql_config)
          gem install mysql --no-rdoc --no-ri -- --with-mysql-config=${mysql_config:-/usr/local/mysql/bin/mysql_config}
        fi
        ;;

      mongodb)
        install_gems mongomapper
        ;;

      sqlite*|*)
        install_gems sqlite
        ;;
    esac
  fi
}

configure_profiles()
{
  # Ensure the .bdsmrc file and the profiles are setup properly.
  file_contains "$HOME/.bashrc" '\.bdsmrc' ||
    echo '[[ -s "$HOME/.bdsmrc" ]] && . "$HOME/.bdsmrc"' \
      >> "$HOME/.bashrc"

  file_contains "$HOME/.bash_profile" '\.bashrc' ||
    echo '[[ "-s $HOME/.bashrc" ]] && . "$HOME/.bashrc"' \
      >> "$HOME/.bash_profile"

  file_contains "$HOME/.bash_profile" '\.rvmrc' ||
    echo '[[ -s "$HOME/current/.rvmrc" ]] && . "$HOME/current/.rvmrc"' \
      >> "$HOME/.bash_profile"
}

configure_bdsmrc()
{
  variable_is_nonempty project ||
    fail "project variable must be set for extension $extension."

  file_contains "$HOME/.bdsmrc" 'project=' ||
    echo "\nexport project=\"${project:-$user}\"" >> $HOME/.bdsmrc

  variable_is_nonempty environment ||
    fail "environment variable must be set for extension $extension."

  file_contains "$HOME/.bdsmrc" 'environment=' ||
    echo "\nexport environment=\"$environment\"" >> $HOME/.bdsmrc

  file_contains "$HOME/.bdsmrc" 'RAILS_ENV=' ||
    echo "\nexport RAILS_ENV=\"$environment\"" >> $HOME/.bdsmrc

  if variable_is_nonempty repository_url ; then
    file_contains "$HOME/.bdsmrc" "repository_url=" ||
      echo "\nexport repository_url=\"$repository_url\"" >> $HOME/.bdsmrc
  fi

  if variable_is_nonempty database ; then
    file_contains "$HOME/.bdsmrc" 'database=' ||
      echo "export database=\"${database}\"" >> $HOME/.bdsmrc
  fi

}

fetch_repository_url()
{
  if [[ "$scm" = "git" ]] || (echo $repository_url | awk "/git/") ; then
    if [[ ! -d "$shared_path/$project/.git" ]] ; then
      git clone $repository_url $project
    fi
  elif [[ "$scm" = "svn" ]] || (echo $repository_url | awk "/svn/") ; then
    if [[ ! -d "$shared_path/$project/.svn" ]] ; then
      svn checkout $repository_url $project
    fi
  elif [[ "$scm" = "hg" ]] || (echo $repository_url | awk "/hg/") ; then
    if [[ ! -d "$shared_path/$project/.hg" ]] ; then
      hg clone $repository_url $project
    fi
  else
    fail "repository_url type not known, expecting {git,svn,hg} in the repository_url url."
  fi
}

setup_shared_path()
{
  (
  enter "$shared_path"
  ensure_paths_exist config log pids sockets "public/assets" tmp
  )
}

configure_rvm()
{
  file_is_nonempty "${HOME}/.rvm/scripts/rvm" ||
    rvm_install

  if file_is_nonempty "$shared_path/$project/.rvmrc" ; then
    export rvm_install_on_use_flag=1
    . "$shared_path/$project/.rvmrc"
  fi
}

setup_application_server()
{
  case "${server:-}" in
    unicorn)
      # TODO: Extension check
      extension_action unicorn setup
      ;;
    mongrel2)
      extension_action mongrel2 setup
      ;;
    thin)
      extension_action thin setup
      ;;
    passenger) # Standalone
      extension_action passenger setup
      ;;
    *)
      # Default to Unicorn
      "$bin_path/bdsm unicorn setup"
      ;;
  esac
}
