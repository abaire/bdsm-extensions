#!/usr/bin/env bash

if [[ "$master_pid" -le 0 ]] ; then
  log "Unicorn herd master not found running for $project $environment, starting."

  [[ -s "$current_path/config/unicorn.rb" ]] || \
    fail "config/unicorn.rb not found, aborting start."

  if [[ -s "$current_path/config.ru" ]] ; then
    unicorn -c "$current_path/config/unicorn.rb" -E "$environment" -D
  else
    unicorn_rails -c "$current_path/config/unicorn.rb" -E "$environment" -D
  fi
else
  log "Master pid '$master_pid' found."

  log "Signaling herd master '$master_pid' for $project $environment to re-execute the running binary."

  kill -USR2 ${master_pid}

  log "Unicorn master '$master_pid' for $project $environment should restart within a few seconds, as requests finish processing workers will be replaced."
fi
